export const colorWheelCanvas = document.querySelector('#color-wheel');
export const canvasSize = colorWheelCanvas.clientWidth;
export const radius = 0.45
export const uniformHues = new Float32Array([0.0, 0.003924133420536298, 0.007848266841072597, 0.011118378024852845, 0.013734466971877043, 0.016350555918901243, 0.01831262262916939, 0.020928711576193592, 0.02289077828646174, 0.02485284499672989, 0.026160889470241987, 0.028122956180510136, 0.030085022890778287, 0.031393067364290386, 0.032701111837802485, 0.034009156311314584, 0.03597122302158273, 0.03727926749509483, 0.03858731196860693, 0.03989535644211903, 0.041203400915631135, 0.04251144538914323, 0.04381948986265533, 0.04447351209941138, 0.04578155657292348, 0.04708960104643558, 0.04839764551994768, 0.04905166775670373, 0.050359712230215826, 0.051667756703727925, 0.052321778940483975, 0.053629823413996074, 0.05493786788750817, 0.05559189012426422, 0.05689993459777633, 0.05755395683453238, 0.058862001308044476, 0.059516023544800525, 0.060824068018312624, 0.061478090255068674, 0.06278613472858077, 0.06344015696533682, 0.06409417920209287, 0.06540222367560497, 0.06605624591236102, 0.06736429038587312, 0.06801831262262917, 0.06867233485938522, 0.06998037933289732, 0.07063440156965337, 0.07128842380640942, 0.07259646827992151, 0.07325049051667756, 0.07390451275343361, 0.07455853499018966, 0.07586657946370176, 0.07652060170045781, 0.07717462393721386, 0.07782864617396991, 0.07913669064748201, 0.07979071288423806, 0.08044473512099411, 0.08109875735775017, 0.08175277959450622, 0.08306082406801832, 0.08371484630477437, 0.08436886854153042, 0.08502289077828647, 0.08567691301504252, 0.08698495748855462, 0.08763897972531066, 0.08829300196206671, 0.08894702419882276, 0.08960104643557881, 0.09025506867233486, 0.09090909090909091, 0.09156311314584696, 0.09287115761935906, 0.09352517985611511, 0.09417920209287116, 0.09483322432962721, 0.09548724656638326, 0.09614126880313931, 0.09679529103989536, 0.0974493132766514, 0.09810333551340746, 0.0987573577501635, 0.09941137998691955, 0.10071942446043165, 0.1013734466971877, 0.10202746893394375, 0.1026814911706998, 0.10333551340745585, 0.1039895356442119, 0.10464355788096795, 0.105297580117724, 0.10595160235448005, 0.1066056245912361, 0.10725964682799215, 0.1079136690647482, 0.10856769130150425, 0.1092217135382603, 0.10987573577501634, 0.1105297580117724, 0.11118378024852844, 0.1118378024852845, 0.11249182472204054, 0.1131458469587966, 0.11379986919555266, 0.1144538914323087, 0.11510791366906475, 0.1157619359058208, 0.11641595814257685, 0.1170699803793329, 0.11772400261608895, 0.118378024852845, 0.11903204708960105, 0.1196860693263571, 0.12034009156311315, 0.1209941137998692, 0.12164813603662525, 0.1223021582733813, 0.12295618051013735, 0.1236102027468934, 0.12426422498364945, 0.1249182472204055, 0.12557226945716154, 0.12622629169391758, 0.12688031393067364, 0.12753433616742968, 0.12818835840418574, 0.12884238064094178, 0.12949640287769784, 0.1301504251144539, 0.13080444735120994, 0.131458469587966, 0.13211249182472204, 0.1327665140614781, 0.13342053629823414, 0.1340745585349902, 0.13472858077174624, 0.1353826030085023, 0.13603662524525834, 0.1366906474820144, 0.13734466971877043, 0.1379986919555265, 0.13865271419228253, 0.1393067364290386, 0.13996075866579463, 0.13996075866579463, 0.1406147809025507, 0.14126880313930673, 0.1419228253760628, 0.14257684761281883, 0.1432308698495749, 0.14388489208633093, 0.144538914323087, 0.14519293655984303, 0.1458469587965991, 0.14650098103335513, 0.1471550032701112, 0.14780902550686723, 0.1484630477436233, 0.14911706998037932, 0.1497710922171354, 0.15042511445389142, 0.1510791366906475, 0.15173315892740352, 0.15238718116415959, 0.15304120340091562, 0.15369522563767168, 0.15434924787442772, 0.15500327011118378, 0.15565729234793982, 0.15631131458469588, 0.15696533682145192, 0.15761935905820798, 0.15827338129496402, 0.15892740353172008, 0.15958142576847612, 0.16023544800523218, 0.16088947024198821, 0.16154349247874428, 0.16219751471550034, 0.16285153695225638, 0.16350555918901244, 0.16415958142576847, 0.16481360366252454, 0.16546762589928057, 0.16612164813603664, 0.16742969260954874, 0.16873773708306083, 0.16939175931981687, 0.17069980379332897, 0.17135382603008503, 0.17266187050359713, 0.17396991497710923, 0.17462393721386527, 0.17593198168737736, 0.17724002616088946, 0.17789404839764553, 0.17920209287115763, 0.18051013734466972, 0.18116415958142576, 0.18247220405493786, 0.18312622629169392, 0.18443427076520602, 0.18574231523871812, 0.18639633747547416, 0.18770438194898625, 0.18901242642249835, 0.19032047089601045, 0.19097449313276652, 0.19228253760627861, 0.1935905820797907, 0.19424460431654678, 0.19555264879005888, 0.19686069326357097, 0.19816873773708307, 0.1988227599738391, 0.2001308044473512, 0.2014388489208633, 0.2027468933943754, 0.20340091563113147, 0.20470896010464357, 0.20601700457815567, 0.20732504905166776, 0.20863309352517986, 0.2092871157619359, 0.210595160235448, 0.2119032047089601, 0.2132112491824722, 0.2145192936559843, 0.2158273381294964, 0.2171353826030085, 0.2184434270765206, 0.2197514715500327, 0.22040549378678875, 0.22171353826030085, 0.22302158273381295, 0.22432962720732505, 0.22563767168083715, 0.22694571615434925, 0.22825376062786135, 0.22956180510137345, 0.2315238718116416, 0.2328319162851537, 0.2341399607586658, 0.2354480052321779, 0.23675604970569, 0.2380640941792021, 0.2393721386527142, 0.24133420536298233, 0.24264224983649443, 0.24395029431000653, 0.24525833878351863, 0.2472204054937868, 0.2485284499672989, 0.25049051667756705, 0.2517985611510791, 0.2537606278613473, 0.25506867233485936, 0.2570307390451275, 0.25833878351863965, 0.2603008502289078, 0.2622629169391759, 0.26357096141268804, 0.2655330281229562, 0.2674950948332243, 0.2694571615434925, 0.27141922825376064, 0.2733812949640288, 0.2753433616742969, 0.2779594506213211, 0.27992151733158926, 0.28253760627861346, 0.2844996729888816, 0.2871157619359058, 0.28973185088293, 0.2923479398299542, 0.29561805101373445, 0.29823413996075865, 0.30150425114453894, 0.3054283845650752, 0.30935251798561153, 0.31393067364290383, 0.31916285153695223, 0.3263570961412688, 0.33485938521909747, 0.342053629823414, 0.34793982995421846, 0.35186396337475473, 0.35578809679529105, 0.3590582079790713, 0.3623283191628515, 0.3649444081098757, 0.3675604970568999, 0.3701765860039241, 0.3727926749509483, 0.3754087638979725, 0.37737083060824067, 0.37933289731850883, 0.381294964028777, 0.3832570307390451, 0.38521909744931326, 0.3871811641595814, 0.3891432308698496, 0.39110529758011775, 0.3924133420536298, 0.394375408763898, 0.39568345323741005, 0.3976455199476782, 0.39895356442119034, 0.4002616088947024, 0.4022236756049706, 0.40353172007848265, 0.4048397645519948, 0.40614780902550685, 0.408109875735775, 0.40941792020928713, 0.4107259646827992, 0.41203400915631133, 0.4133420536298234, 0.41465009810333553, 0.4159581425768476, 0.4172661870503597, 0.4185742315238718, 0.4198822759973839, 0.421190320470896, 0.4224983649444081, 0.42315238718116416, 0.4244604316546763, 0.42576847612818836, 0.4270765206017005, 0.42838456507521255, 0.4290385873119686, 0.4303466317854807, 0.4316546762589928, 0.4329627207325049, 0.43361674296926095, 0.4349247874427731, 0.43623283191628515, 0.4368868541530412, 0.4381948986265533, 0.4395029431000654, 0.44015696533682147, 0.44146500981033354, 0.4421190320470896, 0.4434270765206017, 0.4447351209941138, 0.44538914323086987, 0.44669718770438194, 0.447351209941138, 0.4486592544146501, 0.44931327665140613, 0.45062132112491826, 0.4512753433616743, 0.4525833878351864, 0.45323741007194246, 0.45454545454545453, 0.4551994767822106, 0.4565075212557227, 0.45716154349247873, 0.45846958796599085, 0.4591236102027469, 0.4597776324395029, 0.46108567691301505, 0.4617396991497711, 0.4630477436232832, 0.46370176586003925, 0.4643557880967953, 0.4656638325703074, 0.46631785480706345, 0.4676258992805755, 0.4682799215173316, 0.46893394375408765, 0.4702419882275997, 0.4708960104643558, 0.47155003270111184, 0.4728580771746239, 0.47351209941138, 0.47416612164813604, 0.4754741661216481, 0.4761281883584042, 0.47678221059516024, 0.4780902550686723, 0.4787442773054284, 0.47939829954218444, 0.4807063440156965, 0.4813603662524526, 0.48201438848920863, 0.48266841072596467, 0.4839764551994768, 0.48463047743623283, 0.48528449967298887, 0.486592544146501, 0.48724656638325703, 0.48790058862001306, 0.48855461085676916, 0.4898626553302812, 0.49051667756703726, 0.49117069980379335, 0.4918247220405494, 0.49313276651406146, 0.49378678875081755, 0.4944408109875736, 0.4950948332243296, 0.49640287769784175, 0.4970568999345978, 0.4977109221713538, 0.49836494440810986, 0.49901896664486595, 0.5003270111183781, 0.5009810333551341, 0.5016350555918901, 0.5016350555918901, 0.5022890778286462, 0.5029431000654022, 0.5035971223021583, 0.5042511445389143, 0.5049051667756703, 0.5055591890124265, 0.5062132112491825, 0.5062132112491825, 0.5068672334859385, 0.5075212557226946, 0.5081752779594506, 0.5088293001962066, 0.5094833224329627, 0.5101373446697187, 0.5107913669064749, 0.5107913669064749, 0.5114453891432309, 0.5120994113799869, 0.512753433616743, 0.513407455853499, 0.514061478090255, 0.5147155003270111, 0.5153695225637671, 0.5153695225637671, 0.5160235448005233, 0.5166775670372793, 0.5173315892740353, 0.5179856115107914, 0.5186396337475474, 0.5192936559843034, 0.5199476782210595, 0.5206017004578156, 0.5206017004578156, 0.5212557226945717, 0.5219097449313277, 0.5225637671680837, 0.5232177894048398, 0.5238718116415958, 0.5245258338783518, 0.5251798561151079, 0.5251798561151079, 0.525833878351864, 0.52648790058862, 0.5271419228253761, 0.5277959450621321, 0.5284499672988882, 0.5291039895356442, 0.5297580117724002, 0.5304120340091563, 0.5304120340091563, 0.5310660562459124, 0.5317200784826684, 0.5323741007194245, 0.5330281229561805, 0.5336821451929366, 0.5343361674296926, 0.5349901896664486, 0.5356442119032047, 0.5362982341399608, 0.5362982341399608, 0.5369522563767168, 0.5376062786134729, 0.5382603008502289, 0.538914323086985, 0.539568345323741, 0.540222367560497, 0.540876389797253, 0.5415304120340092, 0.5421844342707652, 0.5428384565075213, 0.5434924787442773, 0.5434924787442773, 0.5441465009810333, 0.5448005232177894, 0.5454545454545454, 0.5461085676913014, 0.5467625899280576, 0.5474166121648136, 0.5480706344015697, 0.5487246566383257, 0.5493786788750817, 0.5500327011118378, 0.5506867233485938, 0.55134074558535, 0.551994767822106, 0.552648790058862, 0.5533028122956181, 0.5533028122956181, 0.5539568345323741, 0.5546108567691301, 0.5552648790058862, 0.5559189012426422, 0.5565729234793984, 0.5572269457161544, 0.5578809679529104, 0.5585349901896665, 0.5591890124264225, 0.5598430346631785, 0.5604970568999346, 0.5611510791366906, 0.5618051013734467, 0.5624591236102028, 0.5631131458469588, 0.5637671680837149, 0.5644211903204709, 0.5650752125572269, 0.565729234793983, 0.566383257030739, 0.5670372792674951, 0.5676913015042512, 0.5683453237410072, 0.5689993459777632, 0.5696533682145193, 0.5703073904512753, 0.5709614126880314, 0.5716154349247874, 0.5722694571615435, 0.5729234793982996, 0.5742315238718116, 0.5748855461085677, 0.5755395683453237, 0.5761935905820798, 0.5768476128188358, 0.5775016350555919, 0.578155657292348, 0.578809679529104, 0.57946370176586, 0.5801177240026161, 0.5807717462393721, 0.5814257684761281, 0.5820797907128843, 0.5833878351863964, 0.5840418574231524, 0.5846958796599084, 0.5853499018966645, 0.5860039241334205, 0.5866579463701765, 0.5873119686069327, 0.5879659908436887, 0.5892740353172008, 0.5899280575539568, 0.5905820797907129, 0.5912361020274689, 0.5918901242642249, 0.5925441465009811, 0.5938521909744932, 0.5945062132112492, 0.5951602354480052, 0.5958142576847613, 0.5964682799215173, 0.5977763243950295, 0.5984303466317855, 0.5990843688685416, 0.5997383911052976, 0.6010464355788097, 0.6017004578155657, 0.6023544800523217, 0.6030085022890779, 0.60431654676259, 0.604970568999346, 0.605624591236102, 0.6069326357096141, 0.6075866579463701, 0.6082406801831263, 0.6095487246566383, 0.6102027468933944, 0.6108567691301504, 0.6121648136036625, 0.6128188358404185, 0.6134728580771747, 0.6147809025506867, 0.6154349247874428, 0.6167429692609548, 0.6173969914977109, 0.6187050359712231, 0.6193590582079791, 0.6206671026814912, 0.6213211249182472, 0.6226291693917593, 0.6232831916285154, 0.6245912361020275, 0.6258992805755396, 0.6265533028122956, 0.6278613472858077, 0.6291693917593199, 0.6298234139960759, 0.631131458469588, 0.6324395029431, 0.6337475474166122, 0.6350555918901243, 0.6363636363636364, 0.6376716808371484, 0.6389797253106606, 0.6402877697841727, 0.6415958142576847, 0.6429038587311968, 0.644865925441465, 0.6461739699149771, 0.6481360366252452, 0.6494440810987574, 0.6514061478090255, 0.6540222367560498, 0.6559843034663179, 0.658600392413342, 0.6612164813603663, 0.6644865925441465, 0.6677567037279267, 0.670372792674951, 0.6729888816219751, 0.6756049705689994, 0.6782210595160235, 0.6801831262262917, 0.6821451929365598, 0.684107259646828, 0.6854153041203401, 0.6873773708306082, 0.6886854153041203, 0.6899934597776325, 0.6913015042511446, 0.6926095487246566, 0.6939175931981687, 0.6952256376716809, 0.696533682145193, 0.697841726618705, 0.6991497710922171, 0.6998037933289731, 0.7011118378024853, 0.7024198822759974, 0.7030739045127534, 0.7043819489862655, 0.7056899934597777, 0.7063440156965337, 0.7076520601700458, 0.7083060824068018, 0.7096141268803139, 0.71026814911707, 0.7115761935905821, 0.7122302158273381, 0.7128842380640942, 0.7141922825376062, 0.7148463047743623, 0.7161543492478745, 0.7168083714846305, 0.7174623937213865, 0.7187704381948986, 0.7194244604316546, 0.7200784826684107, 0.7207325049051668, 0.7220405493786789, 0.7226945716154349, 0.723348593852191, 0.724656638325703, 0.7253106605624591, 0.7259646827992152, 0.7266187050359713, 0.7272727272727273, 0.7285807717462394, 0.7292347939829954, 0.7298888162197514, 0.7305428384565075, 0.7311968606932636, 0.7325049051667757, 0.7331589274035317, 0.7338129496402878, 0.7344669718770438, 0.7351209941137998, 0.7357750163505559, 0.737083060824068, 0.7377370830608241, 0.7383911052975801, 0.7390451275343362, 0.7396991497710922, 0.7403531720078482, 0.7410071942446043, 0.7423152387181164, 0.7429692609548725, 0.7436232831916285, 0.7442773054283846, 0.7449313276651406, 0.7455853499018966, 0.7462393721386528, 0.7468933943754088, 0.7475474166121648, 0.7482014388489209, 0.749509483322433, 0.750163505559189, 0.750817527795945, 0.7514715500327012, 0.7521255722694572, 0.7527795945062132, 0.7534336167429693, 0.7540876389797253, 0.7547416612164813, 0.7553956834532374, 0.7560497056899934, 0.7567037279267496, 0.7573577501635056, 0.7580117724002616, 0.7586657946370177, 0.7599738391105297, 0.7606278613472858, 0.7612818835840418, 0.761935905820798, 0.762589928057554, 0.76324395029431, 0.7638979725310661, 0.7645519947678221, 0.7652060170045781, 0.7658600392413342, 0.7665140614780902, 0.7671680837148463, 0.7678221059516024, 0.7684761281883584, 0.7691301504251145, 0.7697841726618705, 0.7704381948986265, 0.7710922171353826, 0.7717462393721386, 0.7724002616088947, 0.7730542838456508, 0.7737083060824068, 0.7743623283191629, 0.7750163505559189, 0.7756703727926749, 0.776324395029431, 0.7769784172661871, 0.7782864617396992, 0.7789404839764552, 0.7795945062132112, 0.7802485284499673, 0.7809025506867233, 0.7815565729234794, 0.7822105951602355, 0.7828646173969915, 0.7835186396337476, 0.7841726618705036, 0.7848266841072596, 0.7854807063440157, 0.7861347285807717, 0.7867887508175277, 0.7874427730542839, 0.7880967952910399, 0.788750817527796, 0.789404839764552, 0.790058862001308, 0.7907128842380641, 0.7913669064748201, 0.7920209287115761, 0.7926749509483323, 0.7933289731850883, 0.7939829954218444, 0.7946370176586004, 0.7952910398953564, 0.7959450621321125, 0.7965990843688685, 0.7972531066056245, 0.7979071288423807, 0.7985611510791367, 0.7992151733158928, 0.7998691955526488, 0.8005232177894048, 0.8011772400261609, 0.8018312622629169, 0.8024852844996729, 0.8037933289731851, 0.8044473512099412, 0.8051013734466972, 0.8057553956834532, 0.8064094179202093, 0.8070634401569653, 0.8077174623937214, 0.8083714846304775, 0.8090255068672335, 0.8096795291039895, 0.8103335513407456, 0.8109875735775016, 0.8116415958142577, 0.8122956180510137, 0.8129496402877698, 0.8136036625245259, 0.8142576847612819, 0.8149117069980379, 0.815565729234794, 0.81621975147155, 0.816873773708306, 0.8175277959450621, 0.8181818181818182, 0.8188358404185743, 0.8194898626553303, 0.8201438848920863, 0.8214519293655984, 0.8221059516023544, 0.8227599738391105, 0.8234139960758666, 0.8240680183126227, 0.8247220405493787, 0.8253760627861347, 0.8260300850228908, 0.8266841072596468, 0.8273381294964028, 0.8279921517331589, 0.828646173969915, 0.8293001962066711, 0.8299542184434271, 0.8306082406801831, 0.8312622629169392, 0.8319162851536952, 0.8325703073904512, 0.8332243296272073, 0.8338783518639634, 0.8345323741007195, 0.8351863963374755, 0.8358404185742315, 0.8364944408109876, 0.8371484630477436, 0.8378024852844996, 0.8391105297580118, 0.8397645519947678, 0.8404185742315239, 0.8410725964682799, 0.841726618705036, 0.842380640941792, 0.843034663178548, 0.8436886854153042, 0.8443427076520602, 0.8449967298888162, 0.8456507521255723, 0.8463047743623283, 0.8469587965990844, 0.8476128188358404, 0.8482668410725964, 0.8489208633093526, 0.8495748855461086, 0.8502289077828646, 0.8508829300196207, 0.8515369522563767, 0.8521909744931327, 0.8528449967298888, 0.854153041203401, 0.854807063440157, 0.855461085676913, 0.8561151079136691, 0.8567691301504251, 0.8574231523871811, 0.8580771746239372, 0.8587311968606932, 0.8593852190974494, 0.8600392413342054, 0.8606932635709614, 0.8613472858077175, 0.8620013080444735, 0.8626553302812295, 0.8633093525179856, 0.8639633747547416, 0.8652714192282538, 0.8659254414650098, 0.8665794637017659, 0.8672334859385219, 0.8678875081752779, 0.868541530412034, 0.86919555264879, 0.8698495748855462, 0.8705035971223022, 0.8711576193590582, 0.8718116415958143, 0.8724656638325703, 0.8737737083060824, 0.8744277305428385, 0.8750817527795945, 0.8757357750163506, 0.8763897972531066, 0.8770438194898627, 0.8776978417266187, 0.8783518639633747, 0.8790058862001308, 0.8796599084368869, 0.880967952910399, 0.881621975147155, 0.882275997383911, 0.8829300196206671, 0.8835840418574231, 0.8842380640941792, 0.8848920863309353, 0.8855461085676913, 0.8868541530412034, 0.8875081752779594, 0.8881621975147155, 0.8888162197514715, 0.8894702419882276, 0.8901242642249837, 0.8907782864617397, 0.8914323086984958, 0.8927403531720078, 0.8933943754087639, 0.8940483976455199, 0.894702419882276, 0.8953564421190321, 0.8960104643557881, 0.8973185088293002, 0.8979725310660562, 0.8986265533028123, 0.8992805755395683, 0.8999345977763243, 0.9012426422498365, 0.9018966644865926, 0.9025506867233486, 0.9032047089601046, 0.9038587311968607, 0.9051667756703728, 0.9058207979071289, 0.9064748201438849, 0.907128842380641, 0.907782864617397, 0.9090909090909091, 0.9097449313276651, 0.9103989535644212, 0.9110529758011773, 0.9123610202746893, 0.9130150425114454, 0.9136690647482014, 0.9143230869849575, 0.9156311314584696, 0.9162851536952257, 0.9169391759319817, 0.9182472204054938, 0.9189012426422498, 0.9195552648790059, 0.920863309352518, 0.9215173315892741, 0.9221713538260301, 0.9234793982995422, 0.9241334205362982, 0.9247874427730542, 0.9260954872465664, 0.9267495094833225, 0.9274035317200785, 0.9287115761935906, 0.9293655984303466, 0.9306736429038587, 0.9313276651406148, 0.9326357096141269, 0.9332897318508829, 0.934597776324395, 0.935251798561151, 0.9365598430346632, 0.9372138652714193, 0.9385219097449313, 0.9391759319816874, 0.9404839764551994, 0.9411379986919556, 0.9424460431654677, 0.9437540876389797, 0.9444081098757358, 0.9457161543492478, 0.94702419882276, 0.947678221059516, 0.9489862655330281, 0.9502943100065402, 0.9516023544800524, 0.9522563767168084, 0.9535644211903205, 0.9548724656638325, 0.9561805101373446, 0.9574885546108568, 0.9587965990843689, 0.9601046435578809, 0.961412688031393, 0.9627207325049052, 0.9646827992151733, 0.9659908436886854, 0.9672988881621976, 0.9692609548724657, 0.9705689993459777, 0.972531066056246, 0.9744931327665141, 0.9764551994767822, 0.9784172661870504, 0.9803793328973185, 0.9829954218443427, 0.9856115107913669, 0.9882275997383911, 0.9914977109221713, 0.9954218443427076, 0.999345977763244]
);

const glCanvas = document.createElement('canvas');
const gl = glCanvas.getContext('webgl2', { antialias: false });


main();
function main() {
  if (!gl) {
    alert('Unable to initialize WebGL. Your browser or machine may not support it.');
    return;
  }
  
  gl.enable(gl.BLEND);
  gl.blendFunc(gl.SRC_ALPHA, gl.ONE_MINUS_SRC_ALPHA);
  const alignment = 1;
  gl.pixelStorei(gl.UNPACK_ALIGNMENT, alignment);

  const vertexShaderSource = `#version 300 es
in vec2 position;
void main() {
  gl_Position = vec4(position * 2.0 - 1.0, 0, 1.0);
}
`;
  const fragmentShaderSource = `#version 300 es
// mediump is a good default
precision mediump float;

out vec4 COLOR;

const float RADIUS = ${radius};
const float TAU = ${Math.PI * 2};
const float PI = ${Math.PI};

uniform sampler2D hues;
uniform vec2 resolution;


// Inverse function for L_r (Luminance)
float reference_white_luminance_to_luminance(float x) {
    const float k_1 = 0.206;
    const float k_2 = 0.03;
    const float k_3 = (1.0 + k_1) / (1.0 + k_2);
    return (x * x + k_1 * x) / (k_3 * (x + k_2));
}

// Convert OKLab to linear RGB
vec3 oklab_to_srgb(float L, float a, float b) {
    float l_ = L + 0.3963377774 * a + 0.2158037573 * b;
    float m_ = L - 0.1055613458 * a - 0.0638541728 * b;
    float s_ = L - 0.0894841775 * a - 1.2914855480 * b;

    float l = pow(l_, 3.0);
    float m = pow(m_, 3.0);
    float s = pow(s_, 3.0);

    return vec3(
        4.0767416621 * l - 3.3077115913 * m + 0.2309699292 * s,
        -1.2684380046 * l + 2.6097574011 * m - 0.3413193965 * s,
        -0.0041960863 * l - 0.7034186147 * m + 1.7076147010 * s
    );
}

vec3 srgb_to_oklab(float r, float g, float b) {
    vec3 rgb = vec3(r, g, b);

    // Convert non-linear RGB to linear RGB
    for (int i = 0; i < 3; i++) {
        if (rgb[i] <= 0.04045) {
            rgb[i] = rgb[i] / 12.92;
        } else {
            rgb[i] = pow((rgb[i] + 0.055) / 1.055, 2.4);
        }
    }
    r = rgb.r;
    g = rgb.g;
    b = rgb.b;

    // Apply transformation to linear RGB
    float l = 0.4122214708 * r + 0.5363325363 * g + 0.0514459929 * b;
    float m = 0.2119034982 * r + 0.6806995451 * g + 0.1073969566 * b;
    float s = 0.0883024619 * r + 0.2817188376 * g + 0.6299787005 * b;

    // Compute cube roots of l, m, and s
    float l_ = pow(l, 1.0 / 3.0);
    float m_ = pow(m, 1.0 / 3.0);
    float s_ = pow(s, 1.0 / 3.0);

    // Convert to OKLab space
    float L = 0.2104542553 * l_ + 0.7936177850 * m_ - 0.0040720468 * s_;
    float A = 1.9779984951 * l_ - 2.4285922050 * m_ + 0.4505937099 * s_;
    float B = 0.0259040371 * l_ + 0.7827717662 * m_ - 0.8086757660 * s_;

    return vec3(L, A, B);
}


// Convert linear RGB to non-linear RGB
vec3 linear_rgb_to_srgb(float r, float g, float b) {
    vec3 rgb = vec3(r, g, b);
    for (int i = 0; i < 3; i++) {
        if (rgb[i] <= 0.0031308) {
            rgb[i] = rgb[i] * 12.92;
        } else {
            rgb[i] = pow(rgb[i], 1.0 / 2.4) * 1.055 - 0.055;
        }
    }
    return rgb;
}

vec3 hsv_to_rgb(float hue) {
    float r = clamp(abs(6.0 * hue - 3.0) - 1.0, 0.0, 1.0);
    float g = clamp(-abs(6.0 * hue - 2.0) + 2.0, 0.0, 1.0);
    float b = clamp(-abs(6.0 * hue - 4.0) + 2.0, 0.0, 1.0);
    return vec3(r, g, b);
}

vec3 get_rgb(float hue, float saturation, float value) {
	vec3 rgb = hsv_to_rgb(hue);
	vec3 lab = srgb_to_oklab(rgb[0], rgb[1], rgb[2]);
	float L_cusp = lab[0];
    float ok_a = lab[1];
    float ok_b = lab[2];
	float C_cusp = sqrt(ok_a * ok_a + ok_b * ok_b);
	ok_a = ok_a / C_cusp;
	ok_b = ok_b / C_cusp;

    float S_max = C_cusp / L_cusp;
    float T_max = C_cusp / (1.0 - L_cusp);

    float S_0 = 0.5;
    float k = 1.0 - S_0 / S_max;
    float L_v = 1.0 - saturation * S_0 / (S_0 + T_max - T_max * k * saturation);
    float C_v = saturation * T_max * S_0 / (S_0 + T_max - T_max * k * saturation);
    // L_v = saturation * (L_cusp - 1.0) + 1.0;
    // C_v = saturation * C_cusp;

    // Compute final L and C values
    float L = value * L_v;
    float C = value * C_v;

    float L_vt = reference_white_luminance_to_luminance(L_v);
    float C_vt = C_v * L_vt / L_v;
    float L_new = reference_white_luminance_to_luminance(L);
    C = C * L_new / L;
    L = L_new;

    vec3 scale_rgb = oklab_to_srgb(L_vt, ok_a * C_vt, ok_b * C_vt);
    float scale_L = pow(1.0 / max(scale_rgb.r, max(scale_rgb.g, scale_rgb.b)), 1.0 / 3.0);
    L *= scale_L;
    C *= scale_L;

    vec3 linear_rgb = oklab_to_srgb(L, C * ok_a, C * ok_b);
    return linear_rgb_to_srgb(linear_rgb.r, linear_rgb.g, linear_rgb.b);
}

vec3 get_color(vec2 pos, float distance_center) {
	// Linear at the edges, more white in the center, gradual change
	float saturation = -0.553 * cos(0.8 * PI * distance_center / RADIUS) + 0.553;
	float value = 1.0;
	float hue = atan(-pos.y, pos.x) / TAU + 0.5;
    hue = texture(hues, vec2(hue,0.0)).r;
	return get_rgb(hue, saturation, value);
}

void main() {
    vec2 uv = vec2(1.0,-1.0) * (0.5 - gl_FragCoord.xy / resolution);
    float distance_center = length(uv);
    if (distance_center <= RADIUS)
    {
        float alpha = clamp((RADIUS - distance_center) * resolution.y * 0.5, 0.0, 1.0);
        COLOR = vec4(get_color(uv, distance_center), alpha);
    }
}
`;
  
  const vertexShader = createShader(gl, gl.VERTEX_SHADER, vertexShaderSource);
  const fragmentShader = createShader(gl, gl.FRAGMENT_SHADER, fragmentShaderSource);
  const program = createProgram(gl, vertexShader, fragmentShader);
  gl.useProgram(program);

  setPositions(program);
  const resolutionUniformLocation = gl.getUniformLocation(program, 'resolution');
  try {
    setHues(program);
  } catch (e) {
    // Do nothing
  }
  
  const draw = () => drawScene(resolutionUniformLocation);
  window.onresize = draw;
  draw()
}

function drawScene(resolutionUniformLocation) {
  glCanvas.width = 
      glCanvas.height = Math.floor(canvasSize * window.devicePixelRatio);
  gl.viewport(0, 0, gl.canvas.width, gl.canvas.height);
  gl.uniform2f(resolutionUniformLocation, glCanvas.width, glCanvas.height);
  const primitiveType = gl.TRIANGLES;
  const offset = 0;
  const count = 6;
  gl.drawArrays(primitiveType, offset, count);
  toImage(glCanvas.width, glCanvas.height);
}

function setPositions(program) {
  const positionBuffer = gl.createBuffer();
  gl.bindBuffer(gl.ARRAY_BUFFER, positionBuffer);
  gl.bufferData(gl.ARRAY_BUFFER, new Float32Array([
        0.0, 0.0, 
        1.0, 0.0, 
        0.0, 1.0,

        1.0, 0.0, 
        1.0, 1.0, 
        0.0, 1.0,
      ]), gl.STATIC_DRAW);
  // Tell the attribute how to get data out of positionBuffer (ARRAY_BUFFER)
  const positionLocation = gl.getAttribLocation(program, 'position');
  const size = 2; // 2 components per iteration
  const type = gl.FLOAT;
  const normalize = false;
  const stride = 0; // 0 = move forward size * sizeof(type) each iteration to get the next position
  let offset = 0; // start at the beginning of the buffer
  gl.vertexAttribPointer(positionLocation, size, type, normalize, stride, offset);
  gl.enableVertexAttribArray(positionLocation);
}

function toImage(width, height) {
  const pixels = new Uint8Array(width * height * 4); // 4 bytes per pixel (RGBA)
  gl.readPixels(0, 0, width, height, gl.RGBA, gl.UNSIGNED_BYTE, pixels);
  colorWheelCanvas.width = width;
  colorWheelCanvas.height = height;
  const ctx = colorWheelCanvas.getContext('2d');
  const imageData = new ImageData(new Uint8ClampedArray(pixels), width, height);
  ctx.putImageData(imageData, 0, 0);
  // Here it is not accounted for that the gl origin is in the bottom left. This is done inside the shader.
  // rescale
  colorWheelCanvas.style.width = 
      colorWheelCanvas.style.width = canvasSize + 'px';
}

function setHues(program) {
  gl.bindTexture(gl.TEXTURE_2D, gl.createTexture());
  const level = 0;
  const internalFormat = gl.R32F;
  const width = 1000;
  const height = 1;
  const border = 0;
  const format = gl.RED;
  const type = gl.FLOAT;
  
  gl.texImage2D(gl.TEXTURE_2D, level, internalFormat, width, height, border, format, type, uniformHues);

  // set the filtering so we don't need mips and it's not filtered
  gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_MIN_FILTER, gl.NEAREST);
  gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_MAG_FILTER, gl.NEAREST);
  // Texture wrapping
  gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_WRAP_S, gl.REPEAT);
  gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_WRAP_T, gl.CLAMP_TO_EDGE);
  
  const textureLocation = gl.getUniformLocation(program, 'hues');
  // Tell the shader to use texture unit 0 for u_texture
  gl.uniform1i(textureLocation, 0);
}

function createProgram(gl, vertexShader, fragmentShader) {
  const program = gl.createProgram();
  gl.attachShader(program, vertexShader);
  gl.attachShader(program, fragmentShader);
  gl.linkProgram(program);
  const success = gl.getProgramParameter(program, gl.LINK_STATUS);
  if (success) {
    return program;
  }

  console.log(gl.getProgramInfoLog(program));
  gl.deleteProgram(program);
}

function createShader(gl, type, source) {
  const shader = gl.createShader(type);
  gl.shaderSource(shader, source);
  gl.compileShader(shader);
  const success = gl.getShaderParameter(shader, gl.COMPILE_STATUS);
  if (success) {
    return shader;
  }
  console.log(gl.getShaderInfoLog(shader));
  gl.deleteShader(shader);
}

export function getColor(x, y) {
  const pixel = new Uint8Array(4);
  x = x * window.devicePixelRatio;
  y = y * window.devicePixelRatio;
  gl.readPixels(x, y, 1.0, 1.0, gl.RGBA, gl.UNSIGNED_BYTE, pixel)
  return {
    r: pixel[0],
    g: pixel[1],
    b: pixel[2],
    a: pixel[3]
  };
}



